# ç¬¬ 6 ç« ï¼šåŸºå‡†æµ‹è¯•

åœ¨[ç¬¬ 5 ç« ï¼šé˜ˆå€¼æ ¡å‡†](05_threshold_calibration_.md)ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ç²¾ç¡®è°ƒæ•´ `threshold` ä»¥åœ¨å¤§è¯­è¨€æ¨¡å‹è°ƒç”¨çš„æˆæœ¬å’Œè´¨é‡ä¹‹é—´å®ç°æ‰€éœ€çš„å¹³è¡¡ã€‚æˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ª[è·¯ç”±ç­–ç•¥](04_router_strategy.md)å¹¶è®¾ç½®äº†å…¶"æˆæœ¬-è´¨é‡æ—‹é’®"ã€‚ä½†ä¸€ä¸ªå…³é”®é—®é¢˜ä»ç„¶å­˜åœ¨ï¼š**æˆ‘ä»¬å¦‚ä½•çŸ¥é“ç²¾å¿ƒè°ƒæ•´çš„è®¾ç½®å®é™…ä¸Šåœ¨ç°å®ä¸–ç•Œä¸­åšå‡ºäº†æ˜æ™ºçš„å†³ç­–å¹¶ä¸ºæˆ‘ä»¬èŠ‚çœäº†æˆæœ¬ï¼Ÿ**

è¿™å°±æ˜¯**åŸºå‡†æµ‹è¯•**æ¦‚å¿µå˜å¾—éå¸¸å®è´µçš„åœ°æ–¹ã€‚

## é—®é¢˜ï¼šè¯æ˜è·¯ç”±å™¨æœ‰æ•ˆ

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨ RouteLLM å¯åŠ¨äº†åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨é€‰å®šçš„[è·¯ç”±ç­–ç•¥](04_router_strategy.md)å’Œæ ¡å‡†çš„[é˜ˆå€¼æ ¡å‡†](05_threshold_calibration_.md)åœ¨[æ¨¡å‹å¯¹](02_model_pair_.md)ä¹‹é—´è‡ªä¿¡åœ°è·¯ç”±æŸ¥è¯¢ã€‚æˆ‘ä»¬*å¸Œæœ›*å®ƒåœ¨ä¿æŒç”¨æˆ·æ»¡æ„çš„åŒæ—¶èŠ‚çœæˆæœ¬ã€‚ä½†æˆ‘ä»¬å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿ

*   æˆ‘ä»¬çš„è·¯ç”±å™¨æ˜¯å¦åœ¨ä¸ç‰ºç‰²å¤ªå¤šè´¨é‡çš„æƒ…å†µä¸‹å°†è¶³å¤Ÿå¤šçš„ç®€å•æŸ¥è¯¢å‘é€åˆ°æ›´ä¾¿å®œçš„æ¨¡å‹ï¼Ÿ
*   å®ƒæ˜¯å¦æ­£ç¡®è¯†åˆ«äº†*éœ€è¦*æ˜‚è´µå¼ºæ¨¡å‹çš„å¤æ‚æŸ¥è¯¢ï¼Ÿ
*   å®ƒçš„æ€§èƒ½ä¸å§‹ç»ˆä½¿ç”¨ä¾¿å®œæ¨¡å‹æˆ–å§‹ç»ˆä½¿ç”¨æ˜‚è´µæ¨¡å‹ç›¸æ¯”å¦‚ä½•ï¼Ÿ
*   å¦‚æœæˆ‘ä»¬æƒ³å°è¯•ä¸åŒçš„[è·¯ç”±ç­–ç•¥](04_router_strategy.md)â€”â€”æˆ‘ä»¬å¦‚ä½•å®¢è§‚åœ°æ¯”è¾ƒå®ƒä»¬ï¼Ÿ

å¦‚æœæ²¡æœ‰åŠæ³•è¡¡é‡è¿™äº›äº‹æƒ…ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯åœ¨ç›²ç›®é£è¡Œã€‚

## è§£å†³æ–¹æ¡ˆï¼šè·¯ç”±å™¨çš„æ ‡å‡†åŒ–æµ‹è¯•

`Benchmark` å°±åƒæ˜¯**è·¯ç”±å™¨çš„æ ‡å‡†åŒ–æµ‹è¯•**ã€‚å°±åƒå­¦ç”Ÿå‚åŠ æ ‡å‡†åŒ–æµ‹è¯•æ¥è¡¡é‡ä»–ä»¬åœ¨æŸä¸ªå­¦ç§‘çš„çŸ¥è¯†ä¸€æ ·ï¼ŒRouteLLM ä½¿ç”¨åŸºå‡†æµ‹è¯•æ¥è¡¡é‡ä¸åŒè·¯ç”±ç­–ç•¥çš„è¡¨ç°å¦‚ä½•ã€‚

å®ƒæä¾›äº†ä¸€ç»„ä¸€è‡´çš„é—®é¢˜å’Œæ¸…æ™°çš„è¯„åˆ†æœºåˆ¶æ¥å®šé‡æµ‹é‡ï¼š

*   **å‡†ç¡®æ€§ï¼š** è·¯ç”±ç³»ç»Ÿç”Ÿæˆçš„å“åº”æœ‰å¤šæ­£ç¡®ï¼Ÿ
*   **æˆæœ¬æ•ˆç‡ï¼š** æœ‰å¤šå°‘ç™¾åˆ†æ¯”çš„è¯·æ±‚è¢«è·¯ç”±åˆ°æ˜‚è´µçš„å¼ºæ¨¡å‹ï¼ˆè¡¨ç¤ºæˆæœ¬ï¼‰ï¼Ÿ
*   **å¼ºæ¨¡å‹åˆ©ç”¨ç‡ï¼š** å¼ºæ¨¡å‹æ˜¯å¦ä»…åœ¨å¿…è¦æ—¶æ‰è¢«æœ‰æ•ˆä½¿ç”¨ï¼Ÿ

é€šè¿‡é’ˆå¯¹å·²çŸ¥åŸºå‡†æµ‹è¯•è¿è¡Œ[è·¯ç”±ç­–ç•¥](04_router_strategy.md)ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1.  **é‡åŒ–æ€§èƒ½ï¼š** è·å¾—è·¯ç”±å™¨å‡†ç¡®æ€§å’Œæˆæœ¬èŠ‚çœçš„å…·ä½“æ•°å­—ã€‚
2.  **æ¯”è¾ƒç­–ç•¥ï¼š** æŸ¥çœ‹å“ªç§[è·¯ç”±ç­–ç•¥](04_router_strategy.md)æœ€é€‚åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚
3.  **éªŒè¯å†³ç­–ï¼š** ç¡®ä¿[é˜ˆå€¼æ ¡å‡†](05_threshold_calibration_.md)æœ‰æ•ˆã€‚
4.  **è·Ÿè¸ªè¿›åº¦ï¼š** ç›‘æ§éšæ—¶é—´çš„æ”¹è¿›ã€‚

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåšå‡ºæ•°æ®é©±åŠ¨çš„å†³ç­–ï¼Œå¹¶ç¡®è®¤ RouteLLM æ­£åœ¨å¸®åŠ©æˆ‘ä»¬å®ç°æ‰€éœ€çš„è´¨é‡å’Œæˆæœ¬èŠ‚çœç›®æ ‡ã€‚

## ğŸ¢åŸºå‡†æµ‹è¯•ä¸­çš„å…³é”®æ¦‚å¿µ

RouteLLM ä½¿ç”¨æ¥è‡ªå¤§è¯­è¨€æ¨¡å‹ç¤¾åŒºçš„çŸ¥ååŸºå‡†æµ‹è¯•ï¼Œå°†å®ƒä»¬é€‚é…ç”¨äºè·¯ç”±è¯„ä¼°ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®æ¦‚å¿µï¼š

| æ¦‚å¿µ              | æè¿°                                                         | RouteLLM ç¤ºä¾‹                                                |
| :---------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **æµ‹è¯•æ•°æ®é›†**    | å…·æœ‰å·²çŸ¥æ­£ç¡®ç­”æ¡ˆæˆ–è´¨é‡åˆ†æ•°çš„å„ç§é—®é¢˜æˆ–ä»»åŠ¡çš„é›†åˆã€‚           | **MMLUï¼š** å­¦æœ¯å¤šé¡¹é€‰æ‹©é¢˜ <br> **MT-Benchï¼š** ç”± GPT-4 è¯„ä¼°çš„å¤šè½®èŠå¤©æœºå™¨äººå¯¹è¯ <br> **GSM8Kï¼š** å°å­¦æ•°å­¦åº”ç”¨é¢˜ã€‚ |
| **è¯„åˆ†æœºåˆ¶**      | ä¸€ç§å®šä¹‰çš„æ–¹å¼æ¥åˆ¤æ–­å¤§è¯­è¨€æ¨¡å‹å¯¹æ¯ä¸ªé—®é¢˜çš„å“åº”çš„è´¨é‡æˆ–æ­£ç¡®æ€§ã€‚ | **å‡†ç¡®æ€§ï¼ˆMMLUã€GSM8Kï¼‰ï¼š** ç­”æ¡ˆæ˜¯å¦æ­£ç¡®ï¼ˆçœŸ/å‡ï¼‰ï¼Ÿ <br> **å¹³å‡åˆ†æ•°ï¼ˆMT-Benchï¼‰ï¼š** å¹³å‡ GPT-4 è¯„åˆ¤åˆ†æ•°ï¼ˆ1-10ï¼‰ã€‚ |
| **é¢„è®¡ç®—ç»“æœ**    | ä¸ºäº†èŠ‚çœæ—¶é—´å’Œé‡‘é’±ï¼ŒåŸºå‡†æµ‹è¯•ä¸ä¼šå®æ—¶è¿è¡Œå¤§è¯­è¨€æ¨¡å‹ã€‚ç›¸åï¼Œå®ƒä»¬ä½¿ç”¨å·²ç»ç”Ÿæˆå¹¶å­˜å‚¨çš„ `strong_model` å’Œ `weak_model` çš„ç»“æœã€‚ | å¯¹äºæ¯ä¸ªé—®é¢˜ï¼ŒRouteLLM çŸ¥é“ GPT-4 æ˜¯å¦ç­”å¯¹äº†ï¼Œä»¥åŠ Mixtral æ˜¯å¦ç­”å¯¹äº†ã€‚ |
| **æˆæœ¬-è´¨é‡æ›²çº¿** | é€šè¿‡æ¨¡æ‹Ÿè·¨è¶Šè®¸å¤šä¸åŒ `threshold` å€¼çš„è·¯ç”±ï¼ŒåŸºå‡†æµ‹è¯•å¯ä»¥ç»˜åˆ¶ä¸€æ¡æ›²çº¿ï¼Œæ˜¾ç¤ºéšç€å¼ºæ¨¡å‹è°ƒç”¨ç™¾åˆ†æ¯”ï¼ˆæˆæœ¬ï¼‰çš„å¢åŠ ï¼Œå‡†ç¡®æ€§å¦‚ä½•å˜åŒ–ã€‚ | ä¸€ä¸ªå›¾è¡¨ï¼Œx è½´ä¸º"å¼ºæ¨¡å‹è°ƒç”¨ï¼ˆ%ï¼‰"ï¼Œy è½´ä¸º"æ€§èƒ½"ï¼ˆä¾‹å¦‚ï¼Œå‡†ç¡®æ€§æˆ–åˆ†æ•°ï¼‰ã€‚ |

## ä½¿ç”¨åŸºå‡†æµ‹è¯•ï¼šè¯„ä¼°è·¯ç”±å™¨

RouteLLM æä¾›äº†ä¸€ä¸ªè„šæœ¬ `evaluate.py` æ¥è¿è¡Œè¿™äº›åŸºå‡†æµ‹è¯•ã€‚å‡è®¾æˆ‘ä»¬æƒ³åœ¨ `MMLU` åŸºå‡†æµ‹è¯•ä¸Šè¯„ä¼° `mf` [è·¯ç”±ç­–ç•¥](04_router_strategy.md)ï¼Œä½¿ç”¨ `gpt-4-1106-preview` ä½œä¸ºå¼ºæ¨¡å‹ï¼Œä½¿ç”¨ `anyscale/mistralai/Mixtral-8x7B-Instruct-v0.1` ä½œä¸ºå¼±æ¨¡å‹ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨è¯„ä¼°å·¥å…·ï¼š

```bash
# åœ¨ MMLU åŸºå‡†æµ‹è¯•ä¸Šè¯„ä¼° 'mf' è·¯ç”±å™¨çš„ç¤ºä¾‹å‘½ä»¤
python -m routellm.evals.evaluate \
  --routers mf \
  --benchmark mmlu \
  --strong-model gpt-4-1106-preview \
  --weak-model anyscale/mistralai/Mixtral-8x7B-Instruct-v0.1 \
  --config config.example.yaml \
  --output ./my_mmlu_results
```

*è¯´æ˜ï¼š
*   `python -m routellm.evals.evaluate`ï¼šè¿™è°ƒç”¨ RouteLLM çš„è¯„ä¼°è„šæœ¬ã€‚
*   `--routers mf`ï¼šæˆ‘ä»¬æŒ‡å®šè¦æµ‹è¯•çš„[è·¯ç”±ç­–ç•¥](04_router_strategy.md)ï¼ˆè¿™é‡Œæ˜¯ `mf`ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æä¾›å¤šä¸ªè·¯ç”±å™¨ã€‚
*   `--benchmark mmlu`ï¼šæˆ‘ä»¬é€‰æ‹©è¦ä½¿ç”¨çš„åŸºå‡†æ•°æ®é›†ï¼ˆè¿™é‡Œæ˜¯ `mmlu`ï¼‰ã€‚
*   `--strong-model` å’Œ `--weak-model`ï¼šè¿™äº›å®šä¹‰äº†åŸºå‡†æµ‹è¯•çš„[æ¨¡å‹å¯¹](02_model_pair_.md)ã€‚åŸºå‡†æµ‹è¯•éœ€è¦çŸ¥é“å“ªäº›å¤§è¯­è¨€æ¨¡å‹æ„æˆæˆ‘ä»¬çš„å¼ºå’Œå¼±é€‰é¡¹ã€‚
*   `--config config.example.yaml`ï¼šè¿™æŒ‡å‘è·¯ç”±å™¨çš„é…ç½®è¯¦ç»†ä¿¡æ¯ï¼Œç±»ä¼¼äºæˆ‘ä»¬å¯åŠ¨[å…¼å®¹ OpenAI çš„æœåŠ¡å™¨](01_openai_compatible_server_.md)çš„æ–¹å¼ã€‚
*   `--output ./my_mmlu_results`ï¼šè¿™æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œå›¾è¡¨å’ŒæŒ‡æ ‡å°†ä¿å­˜åœ¨å…¶ä¸­ã€‚*

å½“æˆ‘ä»¬è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒRouteLLM å°†å‘æ§åˆ¶å°è¾“å‡ºä¸€ä¸ªæŒ‡æ ‡è¡¨å¹¶ç”Ÿæˆä¸€ä¸ªå›¾è¡¨ã€‚è¯¥å›¾è¡¨é€šå¸¸ä¼šæ˜¾ç¤ºï¼š

*   æˆ‘ä»¬çš„è·¯ç”±å™¨åœ¨ä¸€ç³»åˆ—å¼ºæ¨¡å‹è°ƒç”¨ç™¾åˆ†æ¯”ä¸Šçš„æ€§èƒ½ã€‚
*   æ˜¾ç¤ºå§‹ç»ˆä½¿ç”¨å¼±æ¨¡å‹æˆ–å§‹ç»ˆä½¿ç”¨å¼ºæ¨¡å‹çš„åŸºçº¿æ€§èƒ½çš„æ°´å¹³çº¿ã€‚
*   é€šå¸¸è¿˜æœ‰ä¸€æ¡"æœ€ä¼˜"çº¿ï¼Œæ˜¾ç¤ºå¦‚æœè·¯ç”±å™¨*å§‹ç»ˆ*åœ¨å¼ºæ¨¡å‹æ›´å¥½æ—¶é€‰æ‹©å®ƒçš„æœ€ä½³å¯èƒ½æ€§èƒ½ã€‚

è¿™ç§å¯è§†åŒ–è¡¨ç¤ºä½¿æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿè¯„ä¼°è·¯ç”±å™¨çš„æœ‰æ•ˆæ€§åŠå…¶æƒè¡¡ã€‚

## å†…éƒ¨æœºåˆ¶ï¼šåŸºå‡†æµ‹è¯•å¦‚ä½•å·¥ä½œ

è®©æˆ‘ä»¬æ­å¼€è¿è¡Œ `evaluate.py` è„šæœ¬æ—¶å‘ç”Ÿçš„äº‹æƒ…çš„ç¥ç§˜é¢çº±ã€‚

### "å®¡è®¡å‘˜"

å°† `evaluate.py` è„šæœ¬è§†ä¸ºæ£€æŸ¥è·¯ç”±å™¨å†³ç­–çš„**å®¡è®¡å‘˜**ï¼š

1.  **æˆ‘ä»¬ï¼ˆç”¨æˆ·ï¼‰**å‘Šè¯‰"å®¡è®¡å‘˜"ï¼ˆè„šæœ¬ï¼‰ï¼š"åœ¨ MMLU æµ‹è¯•ä¸Šè¯„ä¼°æˆ‘çš„ `mf` è·¯ç”±å™¨ï¼Œä½¿ç”¨ GPT-4 ä½œä¸ºå¼ºæ¨¡å‹ï¼ŒMixtral ä½œä¸ºå¼±æ¨¡å‹ã€‚"
2.  **å®¡è®¡å‘˜å‡†å¤‡å·¥å…·ï¼š** å®¡è®¡å‘˜ä½¿ç”¨æˆ‘ä»¬çš„ `mf` è·¯ç”±å™¨å’Œ[æ¨¡å‹å¯¹](02_model_pair_.md)åˆå§‹åŒ–[æ§åˆ¶å™¨](03_controller_.md)ã€‚å®ƒè¿˜è·å– MMLU æµ‹è¯•é—®é¢˜ï¼Œå…³é”®æ˜¯ï¼Œæ¯ä¸ªé—®é¢˜çš„ GPT-4 å’Œ Mixtral çš„*å·²çŸ¥ç­”æ¡ˆ*ã€‚
3.  **å®¡è®¡å‘˜å‘è·¯ç”±å™¨è¯·æ±‚é¢„æµ‹ï¼š** å¯¹äº MMLU æµ‹è¯•ä¸­çš„*æ¯ä¸€ä¸ªé—®é¢˜*ï¼Œå®¡è®¡å‘˜å°†å…¶å‘é€åˆ° `mf` "ä¸“å®¶"ï¼ˆé€šè¿‡[æ§åˆ¶å™¨](03_controller_.md)çš„[è·¯ç”±ç­–ç•¥](04_router_strategy.md)ï¼‰å¹¶è¯¢é—®ï¼š"*è¿™ä¸ªç‰¹å®šé—®é¢˜*çš„ `strong_win_rate` æ˜¯å¤šå°‘ï¼Ÿ"
4.  **è·¯ç”±å™¨è¿”å›é¢„æµ‹ï¼š** `mf` ä¸“å®¶å¿«é€Ÿè®¡ç®—å¹¶ä¸ºæ¯ä¸ªé—®é¢˜è¿”å› `strong_win_rate`ï¼ˆ0 åˆ° 1 ä¹‹é—´çš„æ•°å­—ï¼‰ã€‚
5.  **å®¡è®¡å‘˜åœ¨ä¸åŒé˜ˆå€¼ä¸‹æ¨¡æ‹Ÿè·¯ç”±ï¼š** ç„¶åå®¡è®¡å‘˜å‡è£…åº”ç”¨*è®¸å¤šä¸åŒçš„ `threshold` å€¼*ï¼ˆä¾‹å¦‚ï¼Œ0.1ã€0.2ã€0.3...ä¸€ç›´åˆ° 0.9ï¼‰ã€‚å¯¹äºæ¯ä¸ª `threshold`ï¼š
    *   å®ƒæŸ¥çœ‹æ‰€æœ‰ `strong_win_rate` é¢„æµ‹ã€‚
    *   å®ƒæ¨¡æ‹Ÿå“ªäº›é—®é¢˜ä¼šå‘é€åˆ°å¼ºæ¨¡å‹ï¼ˆ`strong_win_rate >= threshold`ï¼‰ï¼Œå“ªäº›å‘é€åˆ°å¼±æ¨¡å‹ï¼ˆ`strong_win_rate < threshold`ï¼‰ã€‚
6.  **å®¡è®¡å‘˜æ£€æŸ¥æ¨¡æ‹Ÿç­”æ¡ˆï¼š** å¯¹äºæ¯ä¸ªæ¨¡æ‹Ÿçš„è·¯ç”±å†³ç­–ï¼Œå®¡è®¡å‘˜çŸ¥é“é€‰å®šæ¨¡å‹ï¼ˆå¼ºæˆ–å¼±ï¼‰ä¼šç»™å‡ºçš„*çœŸå®ç­”æ¡ˆ*ï¼ˆå› ä¸ºå®ƒé¢„å…ˆåŠ è½½äº†ç»“æœï¼‰ã€‚å®ƒå°†æ­¤ä¸æ­£ç¡®ç­”æ¡ˆè¿›è¡Œæ¯”è¾ƒä»¥è®¡ç®—å‡†ç¡®æ€§ã€‚
7.  **å®¡è®¡å‘˜æŠ¥å‘Šæ€§èƒ½ï¼š** å®¡è®¡å‘˜æ”¶é›†æ‰€æœ‰è®¡ç®—çš„å‡†ç¡®æ€§å’Œæ¯ä¸ªæ¨¡æ‹Ÿ `threshold` å¯¹åº”çš„å¼ºæ¨¡å‹è°ƒç”¨ç™¾åˆ†æ¯”ã€‚ç„¶åå®ƒç”Ÿæˆä¸€ä¸ªå›¾è¡¨å’Œè¯¦ç»†çš„æŒ‡æ ‡ï¼Œæ€»ç»“æˆ‘ä»¬è·¯ç”±å™¨çš„æ€§èƒ½ã€‚

### è¯·æ±‚æµç¨‹

```mermaid
sequenceDiagram
    participant User as æ‚¨ï¼ˆè¯„ä¼°ä¸­ï¼‰
    participant EvaluateScript as evaluate.py
    participant Controller as RouteLLM æ§åˆ¶å™¨
    participant RouterStrategy as é€‰å®šçš„è·¯ç”±å™¨ï¼ˆä¾‹å¦‚ï¼ŒMFï¼‰
    participant BenchmarkObject as MMLU åŸºå‡†æµ‹è¯•
    participant StrongLLMResults as é¢„è®¡ç®—çš„å¼ºå¤§è¯­è¨€æ¨¡å‹ç»“æœ
    participant WeakLLMResults as é¢„è®¡ç®—çš„å¼±å¤§è¯­è¨€æ¨¡å‹ç»“æœ

    User->>EvaluateScript: è¿è¡Œå‘½ä»¤ï¼ˆè·¯ç”±å™¨ã€åŸºå‡†æµ‹è¯•ã€æ¨¡å‹ï¼‰
    EvaluateScript->>Controller: åˆå§‹åŒ–ï¼ˆè·¯ç”±å™¨ 'mf'ã€æ¨¡å‹å¯¹ï¼‰
    EvaluateScript->>BenchmarkObject: åŠ è½½é—®é¢˜å’Œé¢„è®¡ç®—çš„å¤§è¯­è¨€æ¨¡å‹ç­”æ¡ˆ
    Note over BenchmarkObject: å­˜å‚¨å¼ºå¤§è¯­è¨€æ¨¡å‹æ˜¯å¦ç­”å¯¹äº† Q1ã€Q2ï¼›å¼±å¤§è¯­è¨€æ¨¡å‹æ˜¯å¦ç­”å¯¹äº† Q1ã€Q2ã€‚
    EvaluateScript->>Controller: batch_calculate_win_rate(all_questions, 'mf')
    Controller->>RouterStrategy: calculate_strong_win_rate(single_question)
    RouterStrategy-->>Controller: strong_win_rateï¼ˆä¾‹å¦‚ï¼Œ0.05ã€0.72ã€0.15...ï¼‰
    Controller-->>EvaluateScript: æ‰€æœ‰é—®é¢˜çš„æ‰€æœ‰ strong_win_rates
    Note over EvaluateScript: ä¸ºå¤šä¸ªé˜ˆå€¼æ¨¡æ‹Ÿè·¯ç”±ï¼ˆä¾‹å¦‚ï¼Œ0-1 ä¹‹é—´çš„ 10 ä¸ªé˜ˆå€¼ï¼‰
    Note over EvaluateScript: å¯¹äºæ¯ä¸ªé˜ˆå€¼ï¼š
    Note over EvaluateScript:   1. æ ¹æ® strong_win_rate ä¸é˜ˆå€¼çš„æ¯”è¾ƒå†³å®šæ¯ä¸ªé—®é¢˜é€‰æ‹©å“ªä¸ªæ¨¡å‹
    Note over EvaluateScript:   2. ä½¿ç”¨é¢„è®¡ç®—ç»“æœï¼ˆStrongLLMResults/WeakLLMResultsï¼‰è·å–å‡†ç¡®æ€§
    EvaluateScript-->>User: æ€§èƒ½å›¾è¡¨å’ŒæŒ‡æ ‡
```

### ä»£ç 

è®©æˆ‘ä»¬çœ‹çœ‹æ¥è‡ª `routellm/evals/benchmarks.py` å’Œ `routellm/evals/evaluate.py` çš„ç®€åŒ–ä»£ç ç‰‡æ®µã€‚

#### 1. `Benchmark` åŸºç±»ï¼ˆ`routellm/evals/benchmarks.py`ï¼‰

æ‰€æœ‰åŸºå‡†æµ‹è¯•å®ç°ï¼ˆMMLUã€MTBenchã€GSM8Kï¼‰éƒ½ç»§æ‰¿è‡ªä¸€ä¸ªé€šç”¨çš„ `Benchmark` ç±»ï¼Œè¯¥ç±»å®šä¹‰äº†è¯„ä¼°çš„æ ‡å‡†æ–¹æ³•ã€‚

```python
# routellm/evals/benchmarks.py
import abc

class Benchmark(abc.ABC):
    """è¯„ä¼°æ¨¡å‹çš„åŸºç±»ã€‚"""

    @abc.abstractmethod
    def evaluate(
        self,
        controller, # RouteLLM æ§åˆ¶å™¨
        router,     # è·¯ç”±å™¨ç­–ç•¥çš„åç§°ï¼ˆä¾‹å¦‚ï¼Œ'mf'ï¼‰
        num_results,# è¦è¯„ä¼°å¤šå°‘ä¸ªé˜ˆå€¼ç‚¹
        overwrite_router_cache,
    ) -> tuple:
        """æ¥å—ä¸€ä¸ªè·¯ç”±å™¨å¹¶è¿”å›æ€§èƒ½æŒ‡æ ‡ã€‚"""
        pass

    @abc.abstractmethod
    def get_model_accuracy(self, model: str) -> float:
        """è¿”å›å•ä¸ªæ¨¡å‹ï¼ˆå¼ºæˆ–å¼±ï¼‰åœ¨æ­¤åŸºå‡†æµ‹è¯•ä¸Šçš„å‡†ç¡®æ€§ã€‚"""
        pass

    # ... å…¶ä»–æŠ½è±¡æ–¹æ³•ï¼Œå¦‚ get_optimal_accuracy ...
```

*è¯´æ˜ï¼š`Benchmark` ç±»å®šä¹‰äº†ä¸€ä¸ªå¥‘çº¦ï¼šä»»ä½•ç‰¹å®šçš„åŸºå‡†æµ‹è¯•ï¼ˆå¦‚ `MMLU` æˆ– `MTBench`ï¼‰éƒ½å¿…é¡»å®ç° `evaluate` æ¥è¿è¡Œè·¯ç”±å™¨ï¼Œå®ç° `get_model_accuracy` æ¥æä¾›å•ä¸ªæ¨¡å‹çš„åŸºçº¿åˆ†æ•°ã€‚*

#### 2. ç¤ºä¾‹ï¼š`MMLU` åŸºå‡†æµ‹è¯•ï¼ˆ`routellm/evals/benchmarks.py`ï¼‰

`MMLU` ç±»å®ç°äº† `Benchmark` æ¥å£ã€‚å®ƒçš„ `evaluate` æ–¹æ³•åè°ƒæ¨¡æ‹Ÿã€‚

```python
# routellm/evals/benchmarks.py
import numpy as np
import pandas as pd
from collections import Counter

class MMLU(Benchmark):
    def __init__(self, domains, routed_pair, overwrite_cache):
        self.routed_pair = routed_pair # å­˜å‚¨å¼ºå’Œå¼±æ¨¡å‹åç§°
        # ... åŠ è½½ MMLU æ•°æ®é›†å’Œæ¥è‡ªå¼º/å¼±æ¨¡å‹çš„é¢„è®¡ç®—ç­”æ¡ˆ ...
        # self.all_data æ˜¯ä¸€ä¸ª DataFrameï¼ŒåŒ…å« 'prompt'ã€'gpt-4-1106-preview'ï¼ˆå¦‚æœæ­£ç¡®åˆ™ä¸º True/Falseï¼‰ã€'mistralai/Mixtral-8x7B-Instruct-v0.1'ï¼ˆå¦‚æœæ­£ç¡®åˆ™ä¸º True/Falseï¼‰

    def evaluate(self, controller, router, num_results, overwrite_router_cache):
        # 1. ä»æ§åˆ¶å™¨è·å–æ‰€æœ‰æç¤ºçš„ strong_win_rates
        strong_win_rates = controller.batch_calculate_win_rate(
            prompts=self.all_data["prompt"], router=router
        )
        self.all_data["strong_win_rates"] = strong_win_rates

        # 2. ç¡®å®šè¦è¯„ä¼°çš„é˜ˆå€¼ï¼ˆä¾‹å¦‚ï¼Œ10 ä¸ªç­‰é—´è·çš„ç™¾åˆ†ä½æ•°ï¼‰
        _, thresholds = pd.qcut(strong_win_rates, num_results, retbins=True)

        for i, threshold in enumerate(thresholds):
            # 3. ä¸ºæ­¤é˜ˆå€¼æ¨¡æ‹Ÿè·¯ç”±å†³ç­–
            selection = self.all_data["strong_win_rates"] >= threshold

            # 4. ä½¿ç”¨é¢„è®¡ç®—ç»“æœè·å–ç»“æœ
            results = np.where(
                selection,
                self.all_data[self.routed_pair.strong], # å¦‚æœé€‰æ‹©äº†å¼ºæ¨¡å‹çš„ç­”æ¡ˆ
                self.all_data[self.routed_pair.weak],  # å¦‚æœé€‰æ‹©äº†å¼±æ¨¡å‹çš„ç­”æ¡ˆ
            )
            # 5. è·Ÿè¸ªé€‰æ‹©äº†å“ªä¸ªæ¨¡å‹
            models = np.where(
                selection, self.routed_pair.strong, self.routed_pair.weak
            )
            model_counts = Counter(models) # ç»Ÿè®¡å¼ºä¸å¼±è°ƒç”¨

            # 6. ä¸ºæ­¤é˜ˆå€¼äº§ç”Ÿç»“æœ
            yield threshold, sum(results) / len(results) * 100, model_counts, len(results)
```

*è¯´æ˜ï¼š`MMLU` åŸºå‡†æµ‹è¯•çš„ `evaluate` æ–¹æ³•é¦–å…ˆè¦æ±‚[æ§åˆ¶å™¨](03_controller_.md)è·å–æ‰€æœ‰ MMLU é—®é¢˜çš„ `strong_win_rate` é¢„æµ‹ã€‚ç„¶åï¼Œå®ƒç”Ÿæˆå‡ ä¸ª `threshold` å€¼ã€‚å¯¹äºæ¯ä¸ª `threshold`ï¼Œå®ƒæ¨¡æ‹Ÿè·¯ç”±å†³ç­–ï¼ˆä½¿ç”¨ `np.where`ï¼‰ï¼ŒæŸ¥æ‰¾é€‰å®šæ¨¡å‹å“åº”çš„é¢„å…ˆè®°å½•çš„æ­£ç¡®/ä¸æ­£ç¡®çŠ¶æ€ï¼ˆ`self.all_data[self.routed_pair.strong]` æˆ– `self.all_data[self.routed_pair.weak]`ï¼‰ï¼Œå¹¶è®¡ç®—è¯¥ `threshold` çš„æ•´ä½“å‡†ç¡®æ€§å’Œæ¨¡å‹åˆ©ç”¨ç‡ã€‚*

#### 3. `evaluate.py` è„šæœ¬ï¼ˆ`routellm/evals/evaluate.py`ï¼‰

è¿™æ˜¯å°†æ‰€æœ‰å†…å®¹è”ç³»åœ¨ä¸€èµ·çš„ä¸»è„šæœ¬ã€‚

```python
# routellm/evals/evaluate.py
import argparse
import pandas as pd
import matplotlib.pyplot as plt # ç”¨äºç»˜å›¾
from routellm.controller import Controller
from routellm.evals.benchmarks import MMLU, MTBench, GSM8K

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    # ... å‚æ•°å®šä¹‰ï¼ˆè·¯ç”±å™¨ã€åŸºå‡†æµ‹è¯•ã€å¼º/å¼±æ¨¡å‹ç­‰ï¼‰...
    args = parser.parse_args()

    # åˆå§‹åŒ–æ§åˆ¶å™¨ï¼Œå®ƒåŠ è½½æˆ‘ä»¬é€‰æ‹©çš„è·¯ç”±å™¨
    controller = Controller(
        routers=args.routers,
        strong_model=args.strong_model,
        weak_model=args.weak_model,
        # ... å…¶ä»–é…ç½® ...
    )

    # åˆå§‹åŒ–ç‰¹å®šçš„åŸºå‡†æµ‹è¯•ï¼ˆä¾‹å¦‚ï¼ŒMMLUï¼‰
    if args.benchmark == "mmlu":
        benchmark = MMLU(ALL_MMLU_DOMAINS, controller.model_pair, args.overwrite_cache)
    # ... elif ç”¨äº mt-benchã€gsm8k ...

    all_results = pd.DataFrame()
    for router in controller.routers:
        router_results = []
        for threshold, accuracy, model_counts, total in benchmark.evaluate(
            controller, router, args.num_results, False
        ):
            # æ”¶é›†æ­¤è·¯ç”±å™¨å’Œé˜ˆå€¼çš„ç»“æœ
            router_results.append({
                "method": str(router),
                "threshold": threshold,
                "strong_percentage": model_counts[controller.model_pair.strong] / total * 100,
                "accuracy": accuracy,
            })
        all_results = pd.concat([all_results, pd.DataFrame(router_results)])

    # ç”Ÿæˆå›¾è¡¨å¹¶æ‰“å°æŒ‡æ ‡
    generate_results(all_results, benchmark, args.benchmark, controller.model_pair, args.output)
```

*è¯´æ˜ï¼š`evaluate.py` è„šæœ¬é¦–å…ˆè§£ææˆ‘ä»¬çš„å‘½ä»¤è¡Œå‚æ•°ã€‚ç„¶åå®ƒåˆå§‹åŒ–ä¸­å¤®[æ§åˆ¶å™¨](03_controller_.md)å’Œç‰¹å®šçš„ `Benchmark` å¯¹è±¡ï¼ˆå¦‚ `MMLU`ï¼‰ã€‚å®ƒå¾ªç¯éå†æˆ‘ä»¬æƒ³è¦è¯„ä¼°çš„æ¯ä¸ª[è·¯ç”±ç­–ç•¥](04_router_strategy.md)ï¼Œè°ƒç”¨ `benchmark.evaluate()` æ–¹æ³•ä»¥è·å–è·¨ä¸åŒé˜ˆå€¼çš„æ‰€æœ‰æ€§èƒ½æ•°æ®ï¼ˆå‡†ç¡®æ€§ã€å¼ºæ¨¡å‹ç™¾åˆ†æ¯”ï¼‰ã€‚æœ€åï¼Œå®ƒä½¿ç”¨è¿™äº›æ”¶é›†çš„æ•°æ®ç”Ÿæˆå›¾è¡¨å¹¶æ‰“å°å‡ºè¯¦ç»†çš„æŒ‡æ ‡ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå¯è§†åŒ–å’Œå®šé‡è¯„ä¼°è·¯ç”±å™¨çš„æ€§èƒ½ã€‚*

## ç»“è®º

`Benchmark` æ˜¯éªŒè¯å’Œæ¯”è¾ƒ RouteLLM è®¾ç½®çš„ç»ˆæå·¥å…·ã€‚

- é€šè¿‡ä½¿ç”¨ä¸€è‡´çš„æ•°æ®é›†å’Œæ¸…æ™°çš„è¯„åˆ†è¿è¡Œæ ‡å‡†åŒ–æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥å®šé‡æµ‹é‡[è·¯ç”±ç­–ç•¥](04_router_strategy.md)çš„æœ‰æ•ˆæ€§ï¼Œç¡®ä¿[é˜ˆå€¼æ ¡å‡†](05_threshold_calibration_.md)æ˜¯æœ€ä¼˜çš„ï¼Œå¹¶å°±å¦‚ä½•æœ€å¥½åœ°å®ç°æˆæœ¬èŠ‚çœå’Œè´¨é‡ç›®æ ‡åšå‡ºæ˜æ™ºçš„å†³ç­–ã€‚

æˆ‘ä»¬å¯¹ RouteLLM æ ¸å¿ƒæ¦‚å¿µçš„å­¦ä¹ ä¹‹æ—… END *â˜…,Â°*:.â˜†(ï¿£â–½ï¿£)/.Â°â˜…* ã€‚