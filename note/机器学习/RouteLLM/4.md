# ç¬¬ 4 ç« ï¼šè·¯ç”±ç­–ç•¥

æ¬¢è¿å›æ¥

åœ¨[ç¬¬ 3 ç« ï¼šæ§åˆ¶å™¨](03_controller_.md)ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° `Controller` æ˜¯ RouteLLM çš„ä¸­å¤®å¤§è„‘ï¼Œåè°ƒæ‰€æœ‰è·¯ç”±å†³ç­–ã€‚ä½† `Controller` å®é™…ä¸Š*å¦‚ä½•*åšå‡ºè¿™äº›æ˜æ™ºçš„é€‰æ‹©å‘¢ï¼Ÿå®ƒå¦‚ä½•çŸ¥é“ä½•æ—¶å°†æŸ¥è¯¢å‘é€åˆ°å¼ºå¤§ã€æ˜‚è´µçš„æ¨¡å‹ï¼Œè€Œä¸æ˜¯æ›´ä¾¿å®œã€è¾ƒå¼±çš„æ¨¡å‹ï¼Ÿ

è¿™å°±æ˜¯**è·¯ç”±ç­–ç•¥**æ¦‚å¿µå‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚

## é—®é¢˜ï¼šåšå‡ºæ™ºèƒ½è·¯ç”±å†³ç­–

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨å°è¯•ç®¡ç†ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹çš„åº”ç”¨ç¨‹åºçš„æˆæœ¬ã€‚æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†[æ¨¡å‹å¯¹](02_modelpair_.md)ï¼šä¸€ä¸ªå¼ºæ¨¡å‹ï¼ˆå¦‚ GPT-4ï¼‰å’Œä¸€ä¸ªå¼±æ¨¡å‹ï¼ˆå¦‚ Mixtralï¼‰ã€‚å½“æ–°çš„ç”¨æˆ·æŸ¥è¯¢åˆ°è¾¾æ—¶ï¼Œä¾‹å¦‚"ç”¨ä¸€å¥è¯è§£é‡Šå…‰åˆä½œç”¨"ï¼Œæˆ‘ä»¬å¦‚ä½•å†³å®šå“ªä¸ªæ¨¡å‹åº”è¯¥å¤„ç†å®ƒï¼Ÿ

*   å°†å…¶å‘é€åˆ° GPT-4 å¯¹äºå¦‚æ­¤ç®€å•çš„æŸ¥è¯¢æ¥è¯´æ˜¯å¤§æå°ç”¨ï¼Œæµªè´¹é‡‘é’±ã€‚
*   å°†éå¸¸å¤æ‚çš„æŸ¥è¯¢å‘é€åˆ° Mixtral å¯èƒ½ä¼šå¯¼è‡´è´¨é‡å·®çš„ç­”æ¡ˆï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°æ²®ä¸§ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ç§æ™ºèƒ½çš„æ–¹å¼æ¥é¢„æµ‹ï¼Œå¯¹äºæ¯ä¸ªå•ç‹¬çš„æŸ¥è¯¢ï¼Œå“ªä¸ªæ¨¡å‹*æœ€æœ‰å¯èƒ½*æä¾›è¶³å¤Ÿå¥½çš„ç­”æ¡ˆï¼ŒåŒæ—¶ä»ç„¶è€ƒè™‘æˆæœ¬ã€‚

## è§£å†³æ–¹æ¡ˆï¼šä¸“ä¸šçš„ä¸“å®¶é¡¾é—®

`Router` ç­–ç•¥å°±åƒä¸ºæ¯ä¸ªæŸ¥è¯¢è˜è¯·ä¸€ä½**ä¸“ä¸šçš„ä¸“å®¶é¡¾é—®**ã€‚è¿™ä½é¡¾é—®çš„å·¥ä½œæ˜¯æŸ¥çœ‹ç”¨æˆ·çš„æç¤ºï¼Œå¹¶å¯¹æˆ‘ä»¬çš„*å¼ºæ¨¡å‹*ç›¸å¯¹äº*å¼±æ¨¡å‹*åœ¨è¯¥ç‰¹å®šæç¤ºä¸Š"è·èƒœ"ï¼ˆå³è¡¨ç°æ˜æ˜¾æ›´å¥½ï¼‰çš„å¯èƒ½æ€§åšå‡ºæœ‰æ ¹æ®çš„çŒœæµ‹ã€‚

è¿™ä¸ªé¢„æµ‹ç§°ä¸º**"å¼ºæ¨¡å‹èƒœç‡"**â€”â€”é€šå¸¸æ˜¯ä»‹äº 0 å’Œ 1 ä¹‹é—´çš„æ•°å­—ã€‚

å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1.  **åˆ†ææŸ¥è¯¢ï¼š** è·¯ç”±ç­–ç•¥æ£€æŸ¥ç”¨æˆ·çš„æç¤ºã€‚
2.  **é¢„æµ‹"å¼ºæ¨¡å‹èƒœç‡"ï¼š** æ ¹æ®å…¶å†…éƒ¨é€»è¾‘ï¼ˆä¸åŒç­–ç•¥ä¹‹é—´å¯èƒ½éå¸¸ä¸åŒï¼‰ï¼Œå®ƒé¢„æµ‹ä¸€ä¸ª `strong_win_rate`ã€‚
    *   é«˜ `strong_win_rate`ï¼ˆä¾‹å¦‚ï¼Œ0.9ï¼‰æ„å‘³ç€å¼ºæ¨¡å‹å¾ˆå¯èƒ½ä¼˜äºå¼±æ¨¡å‹ã€‚
    *   ä½ `strong_win_rate`ï¼ˆä¾‹å¦‚ï¼Œ0.1ï¼‰æ„å‘³ç€å¼±æ¨¡å‹å¯èƒ½è¡¨ç°å¾—ä¸€æ ·å¥½ï¼Œæˆ–è€…å¼ºæ¨¡å‹å¹¶æ²¡æœ‰æ˜æ˜¾æ›´å¥½ã€‚
3.  **ä¸é˜ˆå€¼æ¯”è¾ƒï¼š** ç„¶å `Controller` è·å–è¿™ä¸ª `strong_win_rate` å¹¶å°†å…¶ä¸æˆ‘ä»¬æä¾›çš„ `threshold` è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ª `threshold` æ˜¯æˆ‘ä»¬çš„"æˆæœ¬-è´¨é‡æ—‹é’®"â€”â€”å®ƒå†³å®šäº†æˆ‘ä»¬æ„¿æ„ä¸ºå¼ºæ¨¡å‹ä»˜è´¹çš„é¢‘ç‡ã€‚
    *   å¦‚æœ `strong_win_rate >= threshold`ï¼Œ`Controller` å°†æŸ¥è¯¢è·¯ç”±åˆ°**å¼ºæ¨¡å‹**ã€‚
    *   å¦‚æœ `strong_win_rate < threshold`ï¼Œ`Controller` å°†æŸ¥è¯¢è·¯ç”±åˆ°**å¼±æ¨¡å‹**ã€‚

è¿™ä½¿å¾— RouteLLM èƒ½å¤Ÿä¸º*æ¯ä¸€ä¸ªè¯·æ±‚*åšå‡ºæ™ºèƒ½çš„ã€æ•°æ®é©±åŠ¨çš„å†³ç­–ï¼Œå¹³è¡¡è´¨é‡å’Œæˆæœ¬ã€‚

## ğŸ¢ä¸åŒæ–¹æ³•çš„ä¸åŒè·¯ç”±ç­–ç•¥

RouteLLM æä¾›äº†å‡ ä¸ª"ä¸“å®¶é¡¾é—®"ï¼Œæ¯ä¸ªéƒ½ä½¿ç”¨ä¸åŒçš„æ–¹æ³•æ¥è®¡ç®—å…³é”®çš„ `strong_win_rate`ï¼š

| ç­–ç•¥åç§°     | å·¥ä½œåŸç†ï¼ˆç±»æ¯”ï¼‰                                            | æ ¸å¿ƒé€»è¾‘                                           | ä½•æ—¶ä½¿ç”¨                                             |
| :----------- | :---------------------------------------------------------- | :------------------------------------------------- | :--------------------------------------------------- |
| `mf`         | **çŸ©é˜µåˆ†è§£ï¼š** åƒç”µå½±æ¨èç³»ç»Ÿä¸€æ ·å­¦ä¹ éšè—åå¥½ã€‚             | ä½¿ç”¨æç¤ºå’Œæ¨¡å‹çš„åµŒå…¥æ¥æ ¹æ®è¿‡å»çš„æ•°æ®é¢„æµ‹èƒœç‡ã€‚     | è‰¯å¥½çš„é€šç”¨è·¯ç”±å™¨ï¼Œåœ¨å¤§å‹å¯¹æˆ˜æ•°æ®é›†ä¸Šè®­ç»ƒã€‚           |
| `sw_ranking` | **ç›¸ä¼¼åº¦åŠ æƒæ’åï¼š** æŸ¥æ‰¾ç±»ä¼¼çš„è¿‡å»é—®é¢˜ã€‚                   | å¯»æ‰¾æœ€ç›¸ä¼¼çš„è¿‡å»æç¤ºå¹¶ä½¿ç”¨å®ƒä»¬çš„ç»“æœè¿›è¡Œé¢„æµ‹ã€‚     | å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªè‰¯å¥½çš„æ ‡è®°æç¤ºæ•°æ®é›†æ—¶æœ‰æ•ˆã€‚             |
| `bert`       | **BERT åˆ†ç±»å™¨ï¼š** ä¸“é—¨çš„æ–‡æœ¬åˆ†ææ¨¡å‹ã€‚                      | å¾®è°ƒçš„ BERT æ¨¡å‹å¯¹æç¤ºçš„éš¾åº¦æˆ–å¼ºæ¨¡å‹åå¥½è¿›è¡Œåˆ†ç±»ã€‚ | éå¸¸é€‚åˆä¸€èˆ¬æ–‡æœ¬åˆ†ç±»ä»»åŠ¡ã€‚                           |
| `causal_llm` | **å› æœå¤§è¯­è¨€æ¨¡å‹ï¼š** ä¸“é—¨è®­ç»ƒç”¨äºé¢„æµ‹åˆ†æ•°çš„å°å‹å¤§è¯­è¨€æ¨¡å‹ã€‚ | ä¸€ä¸ªç´§å‡‘çš„è¯­è¨€æ¨¡å‹ï¼Œè¾“å‡ºè¡¨ç¤ºå¼ºæ¨¡å‹é¢„æœŸæ€§èƒ½çš„åˆ†æ•°ã€‚ | å¯¹äºä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹çš„æ¨ç†ç†è§£æç¤ºä¸­çš„ç»†å¾®å·®åˆ«å¾ˆæœ‰ç”¨ã€‚ |
| `random`     | **éšæœºï¼š** æ·éª°å­ã€‚                                         | ç®€å•åœ°è¿”å› 0 å’Œ 1 ä¹‹é—´çš„éšæœºæ•°ã€‚                   | ç”¨äºæµ‹è¯•ã€åŸºå‡†æµ‹è¯•æˆ–ä½œä¸ºåŸºçº¿æ¯”è¾ƒã€‚                   |

æ¯ç§ç­–ç•¥éƒ½æœ‰å…¶ä¼˜åŠ¿ï¼Œå¹¶ä¸”æ ¹æ®æˆ‘ä»¬çš„æ•°æ®å’Œç‰¹å®šç”¨ä¾‹å¯èƒ½æ›´åˆé€‚ã€‚

## åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è·¯ç”±ç­–ç•¥

æˆ‘ä»¬åœ¨å‘ RouteLLM æœåŠ¡å™¨å‘å‡º API è¯·æ±‚æ—¶ï¼Œç›´æ¥åœ¨ `model` å‚æ•°ä¸­æŒ‡å®šè¦ä½¿ç”¨çš„è·¯ç”±ç­–ç•¥ã€‚

è¿˜è®°å¾—[ç¬¬ 1 ç« ï¼šå…¼å®¹ OpenAI çš„æœåŠ¡å™¨](01_openai_compatible_server_.md)å’Œ[ç¬¬ 3 ç« ï¼šæ§åˆ¶å™¨](03_controller_.md)ä¸­çš„è¿™ä¸€è¡Œå—ï¼Ÿ

```python
from openai import OpenAI

client = OpenAI(
    base_url="http://localhost:6060/v1",
    api_key="sk-whatever-you-want",
)

response = client.chat.completions.create(
    # è¿™é‡Œçš„ 'mf' é€‰æ‹©äº†çŸ©é˜µåˆ†è§£è·¯ç”±ç­–ç•¥
    model="router-mf-0.1",
    messages=[
        {"role": "user", "content": "ç”¨ä¸€å¥è¯è§£é‡Šå…‰åˆä½œç”¨ã€‚"},
    ]
)

print(response.choices[0].message.content)
```

*è¯´æ˜ï¼šé€šè¿‡è®¾ç½® `model="router-mf-0.1"`ï¼Œæˆ‘ä»¬æŒ‡ç¤º[æ§åˆ¶å™¨](03_controller_.md)ä¸ºè¿™ä¸ªç‰¹å®šè¯·æ±‚ä½¿ç”¨ `mf`ï¼ˆçŸ©é˜µåˆ†è§£ï¼‰è·¯ç”±ç­–ç•¥ã€‚`0.1` æ˜¯ `threshold`ï¼ˆæˆ‘ä»¬å°†åœ¨[ç¬¬ 5 ç« ï¼šé˜ˆå€¼æ ¡å‡†](05_threshold_calibration.md)ä¸­è¯¦ç»†æ¢è®¨ï¼‰ã€‚`mf` ç­–ç•¥å°†åˆ†æ"ç”¨ä¸€å¥è¯è§£é‡Šå…‰åˆä½œç”¨"ï¼Œè®¡ç®—ä¸€ä¸ª `strong_win_rate`ï¼Œç„¶å `Controller` å°†ä½¿ç”¨è¯¥ç‡å’Œ `0.1` é˜ˆå€¼æ¥å†³å®šæ˜¯ GPT-4 è¿˜æ˜¯ Mixtral å›ç­”é—®é¢˜ã€‚*

## å†…éƒ¨æœºåˆ¶ï¼šæ§åˆ¶å™¨å¦‚ä½•å’¨è¯¢è·¯ç”±ç­–ç•¥

è®©æˆ‘ä»¬æ­å¼€å¸·å¹•ï¼Œçœ‹çœ‹ `Controller` å®é™…ä¸Šå¦‚ä½•ä¸è¿™äº›"ä¸“å®¶é¡¾é—®"äº¤äº’ã€‚

### é‡æ–°å®¡è§†"ä¸“å®¶é¡¾é—®"ç±»æ¯”

æƒ³è±¡[æ§åˆ¶å™¨](03_controller_.md)ï¼ˆé‚®æ”¿å±€é•¿ï¼‰æ”¶åˆ°ä¸€å°ä¿¡ï¼ˆæˆ‘ä»¬çš„ API è¯·æ±‚ï¼‰ã€‚

1.  **é‚®æ”¿å±€é•¿ï¼ˆæ§åˆ¶å™¨ï¼‰é˜…è¯»æŒ‡ä»¤ï¼š** é‚®æ”¿å±€é•¿åœ¨ä¿¡ä¸Šçœ‹åˆ°"router-mf-0.1"ã€‚"å•Šï¼Œ"ä»–æƒ³ï¼Œ"è¿™å°ä¿¡éœ€è¦ `mf` ä¸“å®¶ï¼Œæˆ‘çš„ç´§æ€¥ç¨‹åº¦æ—‹é’®è®¾ç½®ä¸º 0.1ã€‚"
2.  **é‚®æ”¿å±€é•¿å’¨è¯¢ `mf` ä¸“å®¶ï¼š** é‚®æ”¿å±€é•¿å°†ä¿¡çš„å†…å®¹ï¼ˆç”¨æˆ·æç¤ºï¼‰äº¤ç»™ `mf` ä¸“å®¶ã€‚"æˆ‘ä»¬çš„'å¼ºå¤§è¯­è¨€æ¨¡å‹å¿«é€’æœåŠ¡'å¤„ç†è¿™å°ä¿¡æ¯”æˆ‘ä»¬çš„'å¼±å¤§è¯­è¨€æ¨¡å‹å¸¸è§„æœåŠ¡'åšå¾—æ˜æ˜¾æ›´å¥½çš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿ"
3.  **`mf` ä¸“å®¶è®¡ç®—ï¼š** `mf` ä¸“å®¶åˆ†æè¿™å°ä¿¡ã€‚å®ƒå¯èƒ½ä¼šå°†å…¶ä¸ä¹‹å‰çœ‹åˆ°çš„æ•°åƒå°å…¶ä»–ä¿¡ä»¶è¿›è¡Œæ¯”è¾ƒï¼Œå¯»æ‰¾æ¨¡å¼ã€‚å®ƒè®¡ç®—ä¸€äº›æ•°å­—å¹¶è¿”å›ä¸€ä¸ª"å¼ºæ¨¡å‹èƒœç‡"â€”â€”æ¯”å¦‚è¯´ï¼Œ0.05ã€‚
4.  **é‚®æ”¿å±€é•¿åšå‡ºæœ€ç»ˆå†³å®šï¼š** é‚®æ”¿å±€é•¿å°†ä¸“å®¶çš„ `strong_win_rate`ï¼ˆ0.05ï¼‰ä¸ `threshold`ï¼ˆ0.1ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚ç”±äº 0.05 *å°äº* 0.1ï¼Œé‚®æ”¿å±€é•¿å†³å®šï¼š"å¥½çš„ï¼Œå¼±æœåŠ¡å¯¹è¿™ä¸ªå°±è¶³å¤Ÿäº†ã€‚"
5.  **ä¿¡ä»¶è¢«è·¯ç”±ï¼š** é‚®æ”¿å±€é•¿å°†ä¿¡ä»¶å‘é€åˆ°"å¼±å¤§è¯­è¨€æ¨¡å‹å¸¸è§„æœåŠ¡"ã€‚

### è¯·æ±‚æµç¨‹

```mermaid
sequenceDiagram
    participant App as æ‚¨çš„åº”ç”¨ç¨‹åº
    participant RouteLLMServer as RouteLLM æœåŠ¡å™¨
    participant Controller as RouteLLM æ§åˆ¶å™¨
    participant RouterStrategy as é€‰å®šçš„è·¯ç”±å™¨ï¼ˆä¾‹å¦‚ï¼ŒMFï¼‰
    participant StrongLLM as å¼ºå¤§è¯­è¨€æ¨¡å‹
    participant WeakLLM as å¼±å¤§è¯­è¨€æ¨¡å‹

    App->>RouteLLMServer: API è¯·æ±‚ï¼ˆmodel="router-mf-0.1", promptï¼‰
    RouteLLMServer->>Controller: å¤„ç†è¯·æ±‚
    Note over Controller: è§£æè·¯ç”±å™¨åç§° 'mf' å’Œé˜ˆå€¼ 0.1
    Controller->>RouterStrategy: calculate_strong_win_rate(prompt)
    Note over RouterStrategy: åˆ†ææç¤ºï¼›ä½¿ç”¨å…¶ç‰¹å®šé€»è¾‘ï¼ˆä¾‹å¦‚ï¼Œæœºå™¨å­¦ä¹ æ¨¡å‹ï¼‰
    RouterStrategy-->>Controller: strong_win_rateï¼ˆä¾‹å¦‚ï¼Œ0.05ï¼‰
    Note over Controller: å°† strong_win_rateï¼ˆ0.05ï¼‰ä¸é˜ˆå€¼ï¼ˆ0.1ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚è·¯ç”±åˆ°å¼±å¤§è¯­è¨€æ¨¡å‹ã€‚
    Controller->>WeakLLM: è½¬å‘è¯·æ±‚
    WeakLLM-->>Controller: å¤§è¯­è¨€æ¨¡å‹å“åº”
    Controller-->>RouteLLMServer: å¤§è¯­è¨€æ¨¡å‹å“åº”
    RouteLLMServer-->>App: API å“åº”
```

### ä»£ç 

è®©æˆ‘ä»¬çœ‹çœ‹ä½¿è¿™äº›è·¯ç”±ç­–ç•¥å·¥ä½œçš„å®é™…ä»£ç ã€‚

#### 1. åŸºç¡€è·¯ç”±å™¨ç±»ï¼ˆ`routellm/routers/routers.py`ï¼‰

RouteLLM ä¸­çš„æ‰€æœ‰è·¯ç”±ç­–ç•¥éƒ½éµå¾ªä¸€ä¸ªå…±åŒçš„è“å›¾ï¼Œç”±æŠ½è±¡çš„ `Router` ç±»å®šä¹‰ã€‚è¿™ç¡®ä¿å®ƒä»¬éƒ½æœ‰ä¸€ä¸ª `calculate_strong_win_rate` æ–¹æ³•å’Œä¸€ä¸ª `route` æ–¹æ³•ã€‚

```python
# routellm/routers/routers.pyï¼ˆç®€åŒ–ç‰ˆï¼‰
import abc

class Router(abc.ABC):
    @abc.abstractmethod
    def calculate_strong_win_rate(self, prompt):
        # æ¯ä¸ªè·¯ç”±å™¨éƒ½å¿…é¡»å®ç°è¿™ä¸ªï¼š
        # å®ƒæ¥å—ä¸€ä¸ªæç¤ºå¹¶è¿”å›ä¸€ä¸ªæµ®ç‚¹æ•°ï¼ˆ0-1ï¼‰
        # è¡¨ç¤ºå¼ºæ¨¡å‹çš„é¢„æµ‹èƒœç‡ã€‚
        pass

    def route(self, prompt, threshold, routed_pair):
        # è¿™æ˜¯æ‰€æœ‰ç­–ç•¥çš„é€šç”¨è·¯ç”±é€»è¾‘ï¼
        if self.calculate_strong_win_rate(prompt) >= threshold:
            return routed_pair.strong # ä½¿ç”¨æ¨¡å‹å¯¹ä¸­çš„å¼ºæ¨¡å‹
        else:
            return routed_pair.weak   # ä½¿ç”¨æ¨¡å‹å¯¹ä¸­çš„å¼±æ¨¡å‹
```

*è¯´æ˜ï¼š`Router` ç±»å®šä¹‰äº†æ¥å£ã€‚æ¯ä¸ªç‰¹å®šçš„è·¯ç”±å™¨ï¼ˆå¦‚ `mf` æˆ– `causal_llm`ï¼‰éƒ½å¿…é¡»æœ‰ä¸€ä¸ª `calculate_strong_win_rate` æ–¹æ³•ã€‚`route` æ–¹æ³•åªå®ç°ä¸€æ¬¡ï¼šå®ƒè°ƒç”¨ `calculate_strong_win_rate`ï¼Œç„¶åå°†ç»“æœä¸ `threshold` è¿›è¡Œæ¯”è¾ƒï¼Œä»[æ¨¡å‹å¯¹](02_model_pair.md)ï¼ˆ`routed_pair`ï¼‰ä¸­é€‰æ‹© `strong` æˆ– `weak` æ¨¡å‹ã€‚*

#### 2. ç¤ºä¾‹ç­–ç•¥ï¼šçŸ©é˜µåˆ†è§£ï¼ˆ`routellm/routers/matrix_factorization/model.py` å’Œ `routellm/routers/routers.py`ï¼‰

`MatrixFactorizationRouter` æ˜¯ `Router` ç±»çš„å…·ä½“å®ç°ã€‚å®ƒä½¿ç”¨è®­ç»ƒæ¥é¢„æµ‹èƒœç‡çš„å°å‹ç¥ç»ç½‘ç»œã€‚

```python
# routellm/routers/matrix_factorization/model.pyï¼ˆç®€åŒ–ç‰ˆï¼‰
import torch
from huggingface_hub import PyTorchModelHubMixin

class MFModel(torch.nn.Module, PyTorchModelHubMixin):
    # ... ç¥ç»ç½‘ç»œçš„ __init__ å’Œå…¶ä»–æ–¹æ³• ...

    @torch.no_grad()
    def pred_win_rate(self, model_a_id, model_b_id, prompt):
        # æ­¤æ–¹æ³•ä½¿ç”¨è®­ç»ƒå¥½çš„ç¥ç»ç½‘ç»œè¿›è¡Œé¢„æµ‹ã€‚
        # å®ƒæ¥å—ä¸¤ä¸ªæ¨¡å‹ IDï¼ˆå¼ºå’Œå¼±ï¼‰å’Œæç¤ºã€‚
        logits = self.forward([model_a_id, model_b_id], prompt)
        winrate = torch.sigmoid(logits[0] - logits[1]).item()
        return winrate
```

```python
# routellm/routers/routers.pyï¼ˆç®€åŒ–çš„ MatrixFactorizationRouterï¼‰
from routellm.routers.matrix_factorization.model import MODEL_IDS, MFModel

class MatrixFactorizationRouter(Router):
    def __init__(self, checkpoint_path, strong_model, weak_model, **kwargs):
        # åŠ è½½é¢„è®­ç»ƒçš„ MF ç¥ç»ç½‘ç»œæ¨¡å‹
        self.model = MFModel.from_pretrained(checkpoint_path, **kwargs)
        self.model = self.model.eval().to("cuda" if torch.cuda.is_available() else "cpu")
        # å­˜å‚¨å¼ºæ¨¡å‹å’Œå¼±æ¨¡å‹çš„å†…éƒ¨ ID
        self.strong_model_id = MODEL_IDS[strong_model]
        self.weak_model_id = MODEL_IDS[weak_model]

    def calculate_strong_win_rate(self, prompt):
        # è¿™æ˜¯æ§åˆ¶å™¨å°†è°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘ï¼
        winrate = self.model.pred_win_rate(
            self.strong_model_id, self.weak_model_id, prompt
        )
        return winrate
```

*è¯´æ˜ï¼š`MatrixFactorizationRouter` é€šè¿‡ä» `checkpoint_path` åŠ è½½é¢„è®­ç»ƒçš„ç¥ç»ç½‘ç»œï¼ˆ`MFModel`ï¼‰è¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åï¼Œå®ƒçš„ `calculate_strong_win_rate` æ–¹æ³•åªéœ€è°ƒç”¨åŠ è½½çš„ç¥ç»ç½‘ç»œçš„ `pred_win_rate` å‡½æ•°ï¼Œä¼ å…¥å¼ºæ¨¡å‹å’Œå¼±æ¨¡å‹ ID ä»¥åŠç”¨æˆ·çš„ `prompt`ï¼Œä»¥è·å¾— `strong_win_rate` é¢„æµ‹ã€‚*

#### 3. å¦ä¸€ä¸ªç¤ºä¾‹ï¼šå› æœå¤§è¯­è¨€æ¨¡å‹è·¯ç”±å™¨ï¼ˆ`routellm/routers/causal_llm/model.py` å’Œ `routellm/routers/routers.py`ï¼‰

`CausalLLMRouter` ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ï¼šè®­ç»ƒæ¥è¾“å‡ºåˆ†æ•°çš„å°å‹è¯­è¨€æ¨¡å‹ã€‚

```python
# routellm/routers/causal_llm/model.pyï¼ˆç®€åŒ–ç‰ˆï¼‰
import numpy as np
import torch

class CausalLLMClassifier:
    def __init__(self, config, ckpt_local_path, prompt_format, score_threshold, **kwargs):
        # åŠ è½½ä¸“é—¨çš„å› æœå¤§è¯­è¨€æ¨¡å‹åŠå…¶åˆ†è¯å™¨
        self.model = torch.load(ckpt_local_path) # ç®€åŒ–ç‰ˆï¼Œå®é™…ä½¿ç”¨ get_model
        self.tokenizer = ... # ç®€åŒ–ç‰ˆï¼Œå®é™…ä½¿ç”¨ get_tokenizer
        self.score_threshold = score_threshold
        # ... å…¶ä»–è®¾ç½® ...

    def __call__(self, row):
        # æ­¤æ–¹æ³•ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆé¢„æµ‹
        input_ids = torch.as_tensor(row["input_ids"]).to("cuda").reshape(1, -1)
        with torch.no_grad():
            output_new = self.model.generate(input_ids, ...) # ç®€åŒ–ç‰ˆ
        
        # ç”Ÿæˆåï¼Œå®ƒæ ¹æ®å¤§è¯­è¨€æ¨¡å‹é¢„æµ‹çš„åˆ†æ•°åˆ†å¸ƒè®¡ç®—è·¯ç”±æ¦‚ç‡ï¼ˆbinary_probï¼‰ã€‚
        binary_prob, softmax_scores = self.compute_routing_prob(...) # ç®€åŒ–ç‰ˆ
        row["binary_prob"] = binary_prob
        return row
    
    def compute_routing_prob(self, score_logits):
        # å°†é¢„æµ‹çš„ logits è½¬æ¢ä¸ºè·¯ç”±æ¦‚ç‡
        exp_scores = np.exp(score_logits - np.max(score_logits))
        softmax_scores = exp_scores / np.sum(exp_scores)
        # å¯¹é«˜äºæŸä¸ªé˜ˆå€¼çš„åˆ†æ•°çš„æ¦‚ç‡æ±‚å’Œï¼ˆä¾‹å¦‚ï¼Œ5 åˆ†ä¸­çš„ 4 æˆ– 5 åˆ†ï¼‰
        binary_prob = np.sum(softmax_scores[self.score_threshold - 1 :])
        return binary_prob, softmax_scores
```

```python
# routellm/routers/routers.pyï¼ˆç®€åŒ–çš„ CausalLLMRouterï¼‰
from routellm.routers.causal_llm.model import CausalLLMClassifier

class CausalLLMRouter(Router):
    def __init__(self, checkpoint_path, score_threshold=4, **kwargs):
        # ä½¿ç”¨å…¶æ¨¡å‹å’Œé…ç½®åˆå§‹åŒ– CausalLLMClassifier
        self.router_model = CausalLLMClassifier(
            ckpt_local_path=checkpoint_path,
            score_threshold=score_threshold,
            # ... åŸºäº kwargs çš„å…¶ä»–é…ç½® ...
        )
        self.to_openai_messages = ... # ç”¨äºä¸ºå¤§è¯­è¨€æ¨¡å‹æ ¼å¼åŒ–æç¤ºçš„è¾…åŠ©å·¥å…·

    def calculate_strong_win_rate(self, prompt):
        input_data = {}
        input_data["messages"] = self.to_openai_messages([prompt])
        output = self.router_model(input_data) # è°ƒç”¨ CausalLLMClassifier
        if output is None:
            return 1 # å›é€€ï¼šå¦‚æœé¢„æµ‹å¤±è´¥ï¼Œåˆ™è·¯ç”±åˆ°å¼ºæ¨¡å‹
        else:
            # CausalLLMClassifier é¢„æµ‹*å¼±*æ¨¡å‹è¶³å¤Ÿçš„æ¦‚ç‡ã€‚
            # å› æ­¤ï¼Œå¼ºæ¨¡å‹èƒœç‡æ˜¯ 1 -ï¼ˆå¼±æ¨¡å‹è¶³å¤Ÿçš„æ¦‚ç‡ï¼‰ã€‚
            return 1 - output["binary_prob"]
```

*è¯´æ˜ï¼š`CausalLLMRouter` ä½¿ç”¨ç‰¹æ®Šçš„ `CausalLLMClassifier` åˆå§‹åŒ–å…¶ `router_model`ã€‚å½“è°ƒç”¨ `calculate_strong_win_rate` æ—¶ï¼Œå®ƒä¸ºæ­¤åˆ†ç±»å™¨æ ¼å¼åŒ–æç¤ºï¼Œè¿è¡Œåˆ†ç±»å™¨ï¼Œç„¶åè·å– `binary_prob`ï¼ˆè¡¨ç¤ºå¼±æ¨¡å‹è¶³å¤Ÿçš„å¯èƒ½æ€§ï¼‰å¹¶å°†å…¶è½¬æ¢ä¸º `1 - binary_prob` ä»¥è·å¾— `strong_win_rate`ã€‚*

#### 4. åœ¨æ§åˆ¶å™¨ä¸­åŠ è½½è·¯ç”±å™¨ï¼ˆ`routellm/controller.py`ï¼‰

æœ€åï¼Œè¿˜è®°å¾—[ç¬¬ 3 ç« ï¼šæ§åˆ¶å™¨](03_controller_.md)ä¸­ `Controller` åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶åŠ è½½è¿™äº›è·¯ç”±ç­–ç•¥ï¼š

```python
# routellm/controller.pyï¼ˆç®€åŒ–ç‰ˆï¼‰
from routellm.routers.routers import ROUTER_CLS # å¯¼å…¥è·¯ç”±å™¨ç±»çš„å­—å…¸

class Controller:
    def __init__(self, routers: list[str], strong_model: str, weak_model: str, **kwargs):
        self.model_pair = ModelPair(strong=strong_model, weak=weak_model)
        self.routers = {} # è¿™å°†å­˜å‚¨å®é™…çš„è·¯ç”±å™¨å®ä¾‹

        # å¯¹äºæœåŠ¡å™¨å¯åŠ¨æœŸé—´æä¾›çš„æ¯ä¸ªè·¯ç”±å™¨åç§°ï¼ˆä¾‹å¦‚ï¼Œ"mf"ï¼‰
        for router_name in routers:
            # åˆ›å»ºç‰¹å®šè·¯ç”±å™¨ç±»çš„å®ä¾‹å¹¶å­˜å‚¨å®ƒ
            self.routers[router_name] = ROUTER_CLS[router_name](
                strong_model=strong_model,
                weak_model=weak_model,
                **kwargs.get(router_name, {}) # ä¼ é€’è·¯ç”±å™¨ç‰¹å®šçš„é…ç½®
            )

    # ... å…¶ä»–æ–¹æ³•ï¼ŒåŒ…æ‹¬ _get_routed_model_for_completion ...
    def _get_routed_model_for_completion(
        self, messages: list, router_name: str, threshold: float
    ):
        prompt = messages[-1]["content"]
        router_instance = self.routers[router_name] # è·å–ç‰¹å®šçš„è·¯ç”±å™¨å®ä¾‹
        
        # è°ƒç”¨è·¯ç”±å™¨çš„ route æ–¹æ³•ä»¥è·å–é€‰å®šçš„æ¨¡å‹
        routed_model = router_instance.route(
            prompt, threshold, self.model_pair
        )
        return routed_model
```

*è¯´æ˜ï¼š`Controller` çš„ `__init__` æ–¹æ³•ä½¿ç”¨ `ROUTER_CLS` å­—å…¸ä¸ºè·¯ç”±å™¨åç§°æ‰¾åˆ°æ­£ç¡®çš„ Python ç±»ï¼ˆä¾‹å¦‚ï¼Œ`mf` æ˜ å°„åˆ° `MatrixFactorizationRouter`ï¼‰ã€‚ç„¶åå®ƒåˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œä¼ å…¥ `strong_model` å’Œ `weak_model` åç§°ï¼Œä»¥åŠä»»ä½•è·¯ç”±å™¨ç‰¹å®šçš„é…ç½®ã€‚å½“è¯·æ±‚è¿›æ¥æ—¶ï¼Œ`_get_routed_model_for_completion` æ–¹æ³•åªéœ€æ£€ç´¢å·²åˆ›å»ºçš„è·¯ç”±å™¨å®ä¾‹å¹¶è°ƒç”¨å…¶ `route` æ–¹æ³•ã€‚*

è¿™ç§è®¾ç½®ä½¿ RouteLLM å…·æœ‰é«˜åº¦çµæ´»æ€§ï¼šæˆ‘ä»¬å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è·¯ç”±ç­–ç•¥ï¼Œ`Controller` åªéœ€é€šè¿‡æŸ¥æ‰¾å…¶åç§°å³å¯ä½¿ç”¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªã€‚

## ç»“è®º

è·¯ç”±ç­–ç•¥æ˜¯ RouteLLM æ™ºèƒ½è·¯ç”±èƒŒåçš„"å¤§è„‘"ã€‚

æ¯ä¸ªç­–ç•¥éƒ½æ˜¯ä¸€ä¸ªä¸“é—¨çš„ç®—æ³•ï¼Œå®ƒåˆ†ææˆ‘ä»¬çš„æç¤ºå¹¶è®¡ç®— `strong_win_rate`â€”â€”å¯¹å¼ºæ¨¡å‹è¡¨ç°ä¼šå¥½å¤šå°‘çš„é¢„æµ‹ã€‚ç„¶å[æ§åˆ¶å™¨](03_controller_.md)å°†æ­¤é¢„æµ‹ä¸æˆ‘ä»¬æŒ‡å®šçš„ `threshold` è¿›è¡Œæ¯”è¾ƒï¼Œä»¥åœ¨æˆ‘ä»¬çš„[æ¨¡å‹å¯¹](02_modelpair_.md)ä¹‹é—´åšå‡ºæœ€ç»ˆè·¯ç”±å†³ç­–ã€‚

- æä¾›ä¸åŒçš„ç­–ç•¥ï¼Œå¦‚ `mf`ã€`sw_ranking`ã€`bert`ã€`causal_llm` å’Œ `random`ï¼ŒRouteLLM å…è®¸æˆ‘ä»¬ä¸ºç‰¹å®šéœ€æ±‚é€‰æ‹©æœ€ä½³çš„"ä¸“å®¶é¡¾é—®"ã€‚

ç°åœ¨æˆ‘ä»¬äº†è§£äº†==è·¯ç”±å†³ç­–æ˜¯*å¦‚ä½•*åšå‡ºçš„==ï¼Œä¸‹ä¸€ä¸ªåˆä¹é€»è¾‘çš„é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬==å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„ `threshold` æ¥æ§åˆ¶æˆæœ¬-è´¨é‡å¹³è¡¡==ï¼Ÿè®©æˆ‘ä»¬åœ¨ä¸‹ä¸€ç« ä¸­æ¢è®¨è¿™ä¸ªé—®é¢˜

[ä¸‹ä¸€ç« ï¼šé˜ˆå€¼æ ¡å‡†](05_threshold_calibration_.md)

